<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.solvd.argwinterlab.navigator.db.dao.CityMapper">
	
	<resultMap id="resultCity" type="City">
		<id property="id" column="CITY_ID" />
		<result property="name" column="CITY_NAME" />
		<collection property="stations"
			javaType="ArrayList" ofType="Station">
			<id property="id" column="STATION_ID" />
			<result property="name" column="STATION_NAME" />
			<result property="address" column="STATION_ADDRESS" />
			<collection property="paths"
				javaType="ArrayList" ofType="Path">
				<id property="id" column="PATH_ID" />
				<association property="destiny"
					javaType="Station">
					<id property="id" column="DESTINY_STATION_ID" />
					<result property="name" column="STATION_NAME" />
					<result property="address" column="STATION_ADDRESS" />
				</association>
				<!--<collection property="transports"
					javaType="ArrayList" ofType="AbstractTransport">
					<id property="id" column="TRANSPORT_ID" />
					<result property="model" column="TRANSPORT_MODEL" />
					<result property="weight" column="TRANSPORT_WEIGHT" />
					<result property="name" column="TRANSPORT_NAME" />
					 <discriminator javaType="int" column="TRANSPORT_TYPE">
						<case value="1" resultType="Taxi">
							<id property="id" column="TRANSPORT_ID" />
							<result property="model" column="TRANSPORT_MODEL" />
							<result property="weight" column="TRANSPORT_WEIGHT" />
							<result property="name" column="TRANSPORT_NAME" />
							<result property="company" column="TAXI_COMPANY"/>
						</case>
						<case value="2" resultType="Train">
							<id property="id" column="TRANSPORT_ID" />
							<result property="model" column="TRANSPORT_MODEL" />
							<result property="weight" column="TRANSPORT_WEIGHT" />
							<result property="name" column="TRANSPORT_NAME" />
							<result property="company" column="TRAIN_WAGONS"/>
						</case>
					</discriminator>
				</collection>-->
			</collection>
		</collection>
	</resultMap>

	<sql id="getCityTemplate">
		<![CDATA[
			SELECT
				C.ID AS CITY_ID, C.NAME AS CITY_NAME,
				S.ID AS STATION_ID, S.NAME AS STATION_NAME, S.ADDRESS AS STATION_ADDRESS,
				P.PATH_ID AS PATH_ID,
				-- P.PATH_ORIGIN_ID AS PATH_ORIGIN_ID,
				P.PATH_DESTINY_ID AS DESTINY_STATION_ID,
				S2.NAME AS DESTINY_STATION_NAME, S2.ADDRESS AS DESTINY_STATION_ADDRESS,
				T.ID AS TRANSPORT_ID, T.NAME AS TRANSPORT_NAME, T.TRANSPORT_TYPE AS TRANSPORT_TYPE,
				BS.LINE AS BUS_LINE, TX.COMPANY AS TAXI_COMPANY, TR.WAGONS_AMOUNT AS TRAIN_WAGONS

			FROM CITIES C
			LEFT JOIN STATIONS S ON S.CITY_ID = C.ID
			LEFT JOIN

			(SELECT P4.*
			FROM
				(SELECT
					P3.ID AS PATH_ID,
					P3.ORIGIN_ID AS PATH_ORIGIN_ID,
					P3.DESTINY_ID AS PATH_DESTINY_ID
				FROM
					PATHS AS P3
				UNION ALL
				SELECT
					P2.PATH_ID AS PATH_ID,
					P2.PATH_ORIGIN_ID AS PATH_DESTINY_ID,
					P2.PATH_DESTINY_ID AS PATH_ORIGIN_ID
				FROM
					(SELECT
						P1.ID AS PATH_ID,
						P1.ORIGIN_ID AS PATH_DESTINY_ID,
						P1.DESTINY_ID AS PATH_ORIGIN_ID
					FROM
					PATHS AS P1) P2) P4) P
				ON P.PATH_ORIGIN_ID = S.ID
			LEFT JOIN PATH_has_TRANSPORTS PT ON PT.PATH_ID = P.PATH_ID
			LEFT JOIN TRANSPORTS T ON T.ID = PT.TRANSPORT_ID
			LEFT JOIN STATIONS S2 ON P.PATH_DESTINY_ID = S2.ID
			LEFT JOIN BUSES BS ON BS.ID = PT.TRANSPORT_ID
            LEFT JOIN TAXIS TX ON TX.ID = PT.TRANSPORT_ID
            LEFT JOIN TRAINS TR ON TR.ID = PT.TRANSPORT_ID
		]]>
	</sql>

	<select id="findAll" resultMap="resultCity">
	 	<include refid="getCityTemplate"/>
	</select>

	<select id="findById" resultMap="resultCity">
		<include refid="getCityTemplate"/>
		<![CDATA[
			WHERE C.ID = #{id}
		]]>
	</select>
	<select id="findByName" resultMap="resultCity">
		<![CDATA[
			WHERE C.NAME = #{name}
		]]>
	</select>

    <insert id="save" keyProperty="id" useGeneratedKeys="true" flushCache="false">
        INSERT INTO nav_db.CITIES (NAME) VALUES (#{name})
    </insert>

</mapper>
